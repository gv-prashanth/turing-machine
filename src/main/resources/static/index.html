<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Turning Machine</title>
<script>
	var machineUrl = "";
	var currentRuleNumber = 1;
	var timer;

	function createMachine() {
		var xmlhttp = new XMLHttpRequest(); // new HttpRequest instance 
		xmlhttp.open("POST", "/turningMachine");
		xmlhttp.setRequestHeader("Content-Type", "application/json");
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 201) {
				machineUrl = this.getResponseHeader("Location");
				document.getElementById("manage").innerHTML = '<button id="myButtonId" type="button" onclick="startMachine()">Start</button>';
			}
		};
		xmlhttp.send(constructInputJsonFromUserRules());
	}

	function startMachine() {
		disableScreen('input');
		disableScreen('select');
		timer = setInterval(function() {
			stepTheMachine();
		}, 1000);
		document.getElementById("manage").innerHTML = '<button id="myButtonId" type="button" onclick="stopMachine()">Stop</button>';
	}

	function stopMachine() {
		clearInterval(timer);
		document.getElementById("runMessage").innerHTML = "Stopped.";
		document.getElementById("manage").innerHTML = '<button id="myButtonId" type="button" onclick="startMachine()">Start</button>';
	}

	function constructInputJsonFromUserRules() {
		var toReturn = new Object();
		toReturn.tapeSize = 50;
		toReturn.actionTable = [];
		for (var i = 1; i < currentRuleNumber; i++) {
			var actionRow = new Object();
			actionRow.initialState = document.getElementById(i
					+ "_initialState").value;
			if (document.getElementById(i + "_initialSymbol").value) {
				actionRow.initialSymbol = document.getElementById(i
						+ "_initialSymbol").value;
			} else {
				actionRow.initialSymbol = " ";
			}
			actionRow.finalState = document.getElementById(i + "_finalState").value;
			if (document.getElementById(i + "_finalSymbol").value) {
				actionRow.finalSymbol = document.getElementById(i
						+ "_finalSymbol").value;
			} else {
				actionRow.finalSymbol = " ";
			}
			actionRow.moveTo = document.getElementById(i + "_moveTo").value;
			toReturn.actionTable[i - 1] = actionRow;
		}
		return JSON.stringify(toReturn);
		//return "{ \"tapeSize\": \"50\", \"actionTable\": [ { \"initialState\": 0, \"initialSymbol\": \" \", \"finalState\": 1, \"finalSymbol\": \"0\", \"moveTo\": \"R\" }, { \"initialState\": 1, \"initialSymbol\": \" \", \"finalState\": 0, \"finalSymbol\": \"1\", \"moveTo\": \"R\" } ] }";
	}

	function stepTheMachine() {
		var xmlhttp = new XMLHttpRequest(); // new HttpRequest instance 
		xmlhttp.open("GET", machineUrl);
		xmlhttp.setRequestHeader("Content-Type", "application/json");
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var tape = JSON.parse(this.responseText).Tape.split("");
				var head = JSON.parse(this.responseText).Head;
				document.getElementById("runResult").innerHTML = "";
				document.getElementById("runResult").appendChild(
						getTapeHtmlToPrint(tape, head));
				document.getElementById("runMessage").innerHTML = "Running...";
			} else if (this.readyState == 4 && this.status == 400) {
				stopMachine();
				document.getElementById("runMessage").innerHTML = "Insufficient Tape! This machine will self destruct";
			} else if (this.readyState == 4 && this.status == 404) {
				document.getElementById("runMessage").innerHTML = "Invalid Machine. Please refresh the page.";
			}
		};
		xmlhttp.send();
	}

	function getTapeHtmlToPrint(tape, head) {
		var tbl = document.createElement('table');
		tbl.setAttribute('border', '1');
		var tbdy = document.createElement('tbody');

		var tr = document.createElement('tr');
		for (var j = 0; j < tape.length; j++) {
			var td = document.createElement('td');
			td.setAttribute('width', '10');
			if (head == j + 1) {
				td.setAttribute('bgcolor', 'Tan');
			}
			td.innerHTML = tape[j];
			tr.appendChild(td);
		}
		tbdy.appendChild(tr);

		tbl.appendChild(tbdy);
		return tbl;
	}

	function addNewRule() {
		var table = document.getElementById("myTable");
		var row = table.insertRow(-1);
		var initialState = row.insertCell(0);
		var initialSymbol = row.insertCell(1);
		var finalState = row.insertCell(2);
		var finalSymbol = row.insertCell(3);
		var moveTo = row.insertCell(4);
		initialState.innerHTML = "<center><input type='text' size='5' id="+currentRuleNumber + "_initialState "+"/></center>";
		initialSymbol.innerHTML = "<center><input type='text' size='5' id="+currentRuleNumber + "_initialSymbol "+"/></center>";
		finalState.innerHTML = "<center><input type='text' size='5' id="+currentRuleNumber + "_finalState "+"/></center>";
		finalSymbol.innerHTML = "<center><input type='text' size='5' id="+currentRuleNumber + "_finalSymbol "+"/></center>";
		moveTo.innerHTML = "<select id="+currentRuleNumber + "_moveTo "+"><option value='R'>Right</option><option value='L'>Left</option></select>";
		currentRuleNumber++;
	}

	function disableScreen(tagType) {
		var elems = document.getElementsByTagName(tagType);
		for (var i = 0; i < elems.length; i++) {
			elems[i].disabled = true;
		}
	}
</script>
</head>
<body>
	<h1>Turing Machine</h1>

	<table id="myTable" border=1>
		<tr>
			<th>Initial State</th>
			<th>Initial Symbol</th>
			<th>Final State</th>
			<th>Final Symbol</th>
			<th>Direction</th>
		</tr>
	</table>
	<br>
	<div id="manage">
		<button onclick="addNewRule()">Add a Rule</button>
		<button type="button" onclick="createMachine()">Construct</button>
	</div>
	<br>
	<div id="runResult"></div>
	<br>
	<div id="runMessage"></div>
	<script>
		addNewRule();
		document.getElementById("1_initialState").value = 0;
		document.getElementById("1_initialState").disabled = true;
	</script>
</body>
</html>